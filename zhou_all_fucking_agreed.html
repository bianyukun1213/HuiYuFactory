<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8;" />
    <link rel="shortcut icon" href="favicon.ico" />
    <title>周惠玉觉得很赞</title>
</head>

<body onload="load()">
    <div id="root">
        <div id="functions" style="position:fixed;z-index:3;background-color:white;border:3px solid;opacity:75%;">
            <div style="display:inline-block;vertical-align:top;margin-right:150px;">
                <h1 style="display:block;">周惠玉觉得很<span style="color:red;">赞</span></h1>
                <p style="display:block;color:red;">使用即同意不外传并承担一切责任。</p>
                <hr />
                <image style="display:block;width: 150px;" src="thumbs_up.png" />
            </div>
            <div style="display:inline-block;vertical-align:top;">
                <label for="file" style="display:block;">假条图片：</label>
                <input id="file" type="file" accept=".jpg,.png" style="display:block;margin-bottom:15px;"
                    oninput="loadBackgroundImg(event)" />
                <label for="sign_select" style="display:block;">签名：</label>
                <select id="sign_select" style="display:block;margin-bottom:15px;" oninput="selectSign(event)">
                </select>
                <label for="sign_offset_x" style="display:block;">偏移 X：</label>
                <input id="sign_offset_x" type="range" min="0" max="1" value="0.8" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="setSignOffsetX()" />
                <label for="sign_offset_y" style="display:block;">偏移 Y：</label>
                <input id="sign_offset_y" type="range" min="0" max="1" value="0.8" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="setSignOffsetY()" />
                <label for="sign_scale_x" style="display:block;">缩放 X：</label>
                <input id="sign_scale_x" type="range" min="0.5" max="1" value="1" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="scaleSignX()" />
                <label for="sign_scale_y" style="display:block;">缩放 Y：</label>
                <input id="sign_scale_y" type="range" min="0.5" max="1" value="1" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="scaleSignY()" />
                <label for="sign_rotate" style="display:block;">旋转：</label>
                <input id="sign_rotate" type="range" min="-1" max="1" value="0" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="rotateSign()" />
                <label for="sign_opacity" style="display:block;">透明：</label>
                <input id="sign_opacity" type="range" min="0.5" max="1" value="1" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="setSignOpacity()" />
                <label for="sign_blur" style="display:block;">模糊：</label>
                <input id="sign_blur" type="range" min="0" max="1" value="0" step="0.01"
                    style="display:block;margin-bottom:15px;" oninput="setSignBlur()" />
                <button id="download" style="margin-bottom:15px;" onclick="download()">生成图像</button>
            </div>
        </div>

        <hr />
        <!-- <div id="wrapped" style="height:800px;overflow:auto;"> -->
        <div id="content" style="position:relative;">
            <div id="background" style="position:absolute;z-index:1;width:800px;">
                <img id="img_background" src="example.png" style="width:100%;" />
            </div>
            <div id="sign" style="position:absolute;z-index:2;mix-blend-mode:multiply;">
                <img id="img_sign" style="width:100%;height:100%;" />
            </div>
        </div>
        <!-- </div> -->
    </div>

    <script type="text/javascript" src="https://cdn.staticfile.org/dom-to-image/2.6.0/dom-to-image.min.js">
    </script>
    <script type="text/javascript">
        var signData = [{
            image: 'sign_1.png',
            name: '样式 1',
            width: 200,
            height: 200
        },
        {
            image: 'sign_2.png',
            name: '样式 2',
            width: 320,
            height: 200
        }];
        var select = document.getElementById('sign_select');
        for (var item of signData) {
            select.options.add(new Option(item.name, item.image));
        }
        select.selectedIndex = 0;
        var signWidth = signData[0].width;
        var signHeight = signData[0].height;
        document.getElementById('img_sign').src = signData[0].image;
        window.onresize = function () {
            adjustSign();
        };
        var load = function () {
            adjustSign();
        };
        var loadBackgroundImg = function (event) {
            if (!event.target.files || !event.target.files[0])
                return;
            var output = document.getElementById('img_background');
            URL.revokeObjectURL(output.src);
            output.src = URL.createObjectURL(event.target.files[0]);
            output.onload = function () {
                adjustSign();
            };
        };
        var selectSign = function (event) {
            var index = event.target.options.selectedIndex;
            document.getElementById('img_sign').src = event.target.options[index].value;
            signWidth = signData[index].width;
            signHeight = signData[index].height;
            adjustSign();
        };
        var rotateSign = function () {
            var value = document.getElementById('sign_rotate').value;
            var sign = document.getElementById('sign');
            sign.style.transform = 'rotate(' + 15 * value + 'deg)';
        };
        // 使用 transform 实现缩放和偏移并不能实现我想要的效果。
        var adjustSign = function () {
            scaleSignX();
            scaleSignY();
            setSignOffsetX();
            setSignOffsetY();
        };
        var scaleSignX = function () {
            var value = document.getElementById('sign_scale_x').value;
            var sign = document.getElementById('sign');
            sign.style.width = (signWidth * value) + 'px';
        };
        var scaleSignY = function () {
            var value = document.getElementById('sign_scale_y').value;
            var sign = document.getElementById('sign');
            sign.style.height = (signHeight * value) + 'px';
        };
        var setSignOffsetX = function () {
            var value = document.getElementById('sign_offset_x').value;
            var sign = document.getElementById('sign');
            var backgroundOffsetLeft = document.getElementById('background').offsetLeft;
            var backgroundWidth = document.getElementById('background').offsetWidth;
            var xLimitation = backgroundWidth - sign.offsetWidth;
            sign.style.left = (backgroundOffsetLeft + xLimitation * value) + 'px';
        };
        var setSignOffsetY = function () {
            var value = document.getElementById('sign_offset_y').value;
            var sign = document.getElementById('sign');
            var backgroundOffsetTop = document.getElementById('background').offsetTop;
            var backgroundHeight = document.getElementById('background').offsetHeight;
            var yLimitation = backgroundHeight - sign.offsetHeight;
            sign.style.top = (backgroundOffsetTop + yLimitation * value) + 'px';
        };
        var setSignOpacity = function () {
            var value = document.getElementById('sign_opacity').value;
            var sign = document.getElementById('sign');
            sign.style.opacity = value;
        };
        var setSignBlur = function () {
            var value = document.getElementById('sign_blur').value;
            var sign = document.getElementById('sign');
            sign.style.filter = 'blur(' + 1.5 * value + 'px)';
        };
        var download = function () {
            var node = document.getElementById('content');
            domtoimage.toJpeg(node, {
                width: document.getElementById('img_background').offsetWidth,
                height: document.getElementById('img_background').offsetHeight
            }).then(function (dataUrl) {
                var a = document.createElement('a');
                a.href = dataUrl;
                a.download = 'pic.jpg';
                a.click();
            });
        };
    </script>
</body>

</html>